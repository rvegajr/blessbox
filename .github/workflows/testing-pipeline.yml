name: Comprehensive Testing Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run full pipeline daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '18'
  TEST_DATABASE_URL: 'sqlite:./test.db'
  COVERAGE_THRESHOLD: '80'

jobs:
  # Job 1: Contract Validation (Must pass first)
  contract-validation:
    name: Contract Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run contract validation tests
      run: npm run test:contracts
      
    - name: Upload contract test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: contract-test-results
        path: test-results/
        retention-days: 30

  # Job 2: Unit Tests (Runs after contracts pass)
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: contract-validation
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run unit tests with coverage
      run: npm run test:unit -- --coverage --reporter=json
      
    - name: Check coverage thresholds
      run: |
        COVERAGE=$(node -e "
          const fs = require('fs');
          const coverage = JSON.parse(fs.readFileSync('./coverage/coverage-summary.json'));
          const total = coverage.total;
          const lines = total.lines.pct;
          const functions = total.functions.pct;
          const branches = total.branches.pct;
          const statements = total.statements.pct;
          
          if (lines < ${{ env.COVERAGE_THRESHOLD }} || 
              functions < ${{ env.COVERAGE_THRESHOLD }} || 
              branches < ${{ env.COVERAGE_THRESHOLD }} || 
              statements < ${{ env.COVERAGE_THRESHOLD }}) {
            console.error('Coverage below threshold');
            process.exit(1);
          }
          
          console.log('Coverage thresholds met');
        ")
        
    - name: Upload unit test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          test-results/
          coverage/
        retention-days: 30

  # Job 3: Integration Tests (Runs after unit tests pass)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Setup test database
      run: |
        npm run test:setup
        npm run db:migrate:test
        
    - name: Run integration tests
      run: npm run test:integration
      
    - name: Upload integration test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: integration-test-results
        path: test-results/
        retention-days: 30
        
    - name: Cleanup test environment
      if: always()
      run: npm run test:cleanup

  # Job 4: E2E Tests (Runs after integration tests pass)
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Start application
      run: npm run dev &
      env:
        PORT: 4321
        
    - name: Wait for application to start
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:4321; do sleep 2; done'
        
    - name: Run E2E tests
      run: npm run test:e2e -- --reporter=list
      
    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results
        path: |
          test-results/
          playwright-report/
        retention-days: 30

  # Job 5: Performance Tests (Optional, runs after E2E tests)
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 25
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Install Lighthouse CI
      run: npm install -g @lhci/cli
        
    - name: Start application
      run: npm run dev &
      env:
        PORT: 4321
        
    - name: Wait for application to start
      run: |
        timeout 60 bash -c 'until curl -f http://localhost:4321; do sleep 2; done'
        
    - name: Run Lighthouse CI
      run: |
        lhci autorun --config=./tests/performance/lighthouserc.json
        
    - name: Upload performance test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: .lighthouseci/
        retention-days: 30

  # Job 6: Test Report Generation (Runs after all tests)
  test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [contract-validation, unit-tests, integration-tests, e2e-tests]
    if: always()
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
        
    - name: Download all test artifacts
      uses: actions/download-artifact@v4
      with:
        path: test-artifacts/
        
    - name: Generate comprehensive test report
      run: npm run generate:test-report
      
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: comprehensive-test-report
        path: test-results/
        retention-days: 90

  # Job 7: Notifications (Runs after all tests)
  notifications:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [contract-validation, unit-tests, integration-tests, e2e-tests, test-report]
    if: always()
    timeout-minutes: 5
    
    steps:
    - name: Check test results
      id: check-results
      run: |
        if [ "${{ needs.contract-validation.result }}" == "success" ] && \
           [ "${{ needs.unit-tests.result }}" == "success" ] && \
           [ "${{ needs.integration-tests.result }}" == "success" ] && \
           [ "${{ needs.e2e-tests.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=All tests passed successfully! ðŸŽ‰" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=Some tests failed. Check the logs for details. âŒ" >> $GITHUB_OUTPUT
        fi
        
    - name: Send Slack notification
      if: env.SLACK_WEBHOOK_URL
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ steps.check-results.outputs.status }}
        text: ${{ steps.check-results.outputs.message }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
          });
          
          const botComment = comments.find(comment => comment.user.type === 'Bot');
          
          if (botComment) {
            await github.rest.issues.updateComment({
              comment_id: botComment.id,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Test Results: ${{ steps.check-results.outputs.status }}
              
              ${{ steps.check-results.outputs.message }}
              
              **Contract Tests**: ${{ needs.contract-validation.result }}
              **Unit Tests**: ${{ needs.unit-tests.result }}
              **Integration Tests**: ${{ needs.integration-tests.result }}
              **E2E Tests**: ${{ needs.e2e-tests.result }}
              
              [View full test report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `
            });
          } else {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Test Results: ${{ steps.check-results.outputs.status }}
              
              ${{ steps.check-results.outputs.message }}
              
              **Contract Tests**: ${{ needs.contract-validation.result }}
              **Unit Tests**: ${{ needs.unit-tests.result }}
              **Integration Tests**: ${{ needs.integration-tests.result }}
              **E2E Tests**: ${{ needs.e2e-tests.result }}
              
              [View full test report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              `
            });
          }

# Global timeout for entire workflow
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

